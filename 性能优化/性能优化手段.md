#### 性能优化手段

https://www.yuque.com/jirengu/xcxoqg/gugadx?utm_source=wechat_session&utm_medium=social&utm_oi=685017875778113536

![image-20211103101651279](/Users/Tassel/Library/Application Support/typora-user-images/image-20211103101651279.png)

### webpack构建角度

#### 1 问题分析

##### 1.1 打包速度分析

要优化打包速度，先分析打包耗时，分析每个loader和plugin的耗时情况。

安装以下插件可实现耗时分析

```js
npm i -D speed-measure-webpack-plugin
```

运行打包命令后，即可控制台查看这些插件或loader的打包耗时情况。

#### 1.2 体积分析

分析完打包速度后，还可以分析下打包之后每个文件及模块对应的体积大小，可以安装以下插件实现，构建完成后可以在8888端口展示大小。

```js
npm i -D webpack-bundle-analyzer
```

#### 2 打包优化

##### 2.1 多进程打包多实例构建，资源并行解析

安装以下插件可以实现多进程，多实例构建

```js
npm i -D thread-loader
```

##### 2.2 公用代码提取，使用CDN加载

对于一些基础库，React，axios，echarts等我们可以利用webpack的externals参数配置，比如以下代码我们只设定在生产环境使用CDN

```js
// 导入速度分析插件
const SpeedMeasurePlugin = require("speed-measure-webpack-plugin");

// 导入体积分析插件
const BundleAnalyzerPlugin = require("webpack-bundle-analyzer").BundleAnalyzerPlugin;

//判断是否为生产环境
const isProduction = process.env.NODE_ENV === 'production';

//定义 CDN 路径，这里采用 bootstrap 的 cdn
const cdn = {
    css: [
        'https://cdn.bootcss.com/Swiper/4.5.1/css/swiper.min.css'
    ],
    js: [
        'https://cdn.bootcss.com/vue/2.6.10/vue.min.js',
        'https://cdn.bootcss.com/vue-router/3.1.3/vue-router.min.js',
        'https://cdn.bootcss.com/vuex/3.1.1/vuex.min.js',
        'https://cdn.bootcss.com/axios/0.19.0/axios.min.js',
        'https://cdn.bootcss.com/echarts/4.3.0/echarts.min.js',
        'https://cdn.bootcss.com/Swiper/4.5.1/js/swiper.min.js',
    ]
}

// 实例化插件
const smp = new SpeedMeasurePlugin();
module.exports = {
    chainWebpack: config => {
        // 生产环境配置
        if (isProduction) {
            // 生产环境注入 cdn
            config.plugin('html')
                .tap(args => {
                    args[0].cdn = cdn;
                    return args;
                });
        }
    },
    configureWebpack: smp.wrap({
        module: {
            rules: [
                {
                    test: /\.js$/,
                    use: ['thread-loader']
                }
            ]
        },
        plugins: [
            new BundleAnalyzerPlugin()
        ],
        //生产环境注入 cdn
        externals: isProduction && {
            'vue': 'Vue',
            'vuex': 'Vuex',
            'vue-router': 'VueRouter',
            'axios': 'axios',
            'echarts': 'echarts',
            'swiper': 'Swiper'
        } || {}
    })
}
```

下面改造html页面，用于让我们配置的CDN路径注入到html页面中

```js
<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <!-- 使用 CDN 的 CSS 文件 -->
  <% for (var i in htmlWebpackPlugin.options.cdn && htmlWebpackPlugin.options.cdn.css) { %>
    <link href="<%= htmlWebpackPlugin.options.cdn.css[i] %>" rel="stylesheet">
  <% } %>
</head>

<body>
  <noscript>
    <strong>We're sorry but eye-admin doesn't work properly without JavaScript enabled. Please enable it to continue.</strong>
  </noscript>
  <div id="app"></div>
  <!-- built files will be auto injected -->

 <!-- 使用 CDN 的 JS 文件 -->
  <% for (var i in htmlWebpackPlugin.options.cdn && htmlWebpackPlugin.options.cdn.js) { %>
    <script src="<%= htmlWebpackPlugin.options.cdn.js[i] %>"></script>
  <% } %>
</body>

</html>
```

##### 2.3 多实例多进程并行压缩

并行压缩主要使用以下插件

```js
npm i -D terser-webpack-plugin
```

并开启parallel参数